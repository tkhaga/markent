>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

                          BEEP音によるMMLプレイヤー
                              kmmlplay ver.0.3b

作者：THAGA (たーが又はさが)
      e-mail   thaga@k7.dion.ne.jp
      homepage http://www.h5.dion.ne.jp/~markent

開発ツール：Hot Soup Processor（コンパクト版HSP 2.6β15 ランタイムでコンパイ
ル）

動作環境：PC/AT互換機 Windows95/98/98SE/Me（NT系では別途giveio.sysが必要）

種別：フリーウェア

<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
※＠（アットマーク）でこのファイル内を検索すれば各トピックの先頭に移動できま
す
※メモ帳が最大化されており、画面解像度640×480でフォントがFixedsys（デフォル
ト）のときちょうど画面に収まるようになっています

＠ver.0.3b (03/08/20)での更新点＊＊＊＊

  ・ファイル監視機能を付けた(いい加減スクリプトが破綻しかけてきたので次から
は一から書きなおそうと思います)

＠概要＊＊＊＊

  これはWindows 上でフリーのOS、OSASK 用のソフトとして公開されている小柳雅明
氏作のmmlplay 用のMML ファイルを演奏するためのソフトです。このソフトがあれば
OSASK 用のMML をWindows 上で演奏して確認しながら書くことが出来ます。OSASK で
演奏できるものは全て演奏できるはずです。おまけ的機能として移調をして演奏する
ことも出来ます。
  I/O ポートに直接アクセスするため基本的にはWindows 9x系でしか動作しませんが
、NT系でも同じフォルダにgiveio.sysというファイルを置いておくと、hspio.dll が
動的に読み込み、演奏できるようになります（但しAdmistrator 権限でログインした
ときに限ります）。giveio.sysは

  http://www.ddj.com/ftp/1996/1996.05/directio.zip

  の中に含まれています。
  I/O の仕様の違いのため、PC-98 では使用できませんが、資料を提供してくださる
方がいらっしゃれば、両方で使えるようにします
  混乱を避けるため独自仕様は追加していませんが、例外的にテンポや音長が0 にな
るときにはソフトの既定値が適用されるようになっています。このようなファイルを
OSASK で演奏すると0 での除算が行われ、OSASK そのものがシャットダウンされてし
まいますが、これはmmlplay の言うなれば不具合でありいずれ修正されることが予想
されます。そのためこのソフトでは演奏できるようにしてあります
  音質は機種によって非常に差があります。個人的にはThinkPad 230Csが気に入って
います。逆にDIMENSION 4100は音量が調節できずあまり好きではありません
  ちなみに、kmmlplayの"k" は川合氏、小柳氏、Ｋ－Ｋ氏の頭文字です。私の学校の
名前の頭文字でもあります(^^;
  MML でないファイル（例えばこのファイル）を演奏してみるのも面白いですよ(^^;
  OSASK 用のMML ファイルはOSASK 開発の中心である川合氏のホームページでまとま
ったものを入手できます。川合氏のホームページは
  http://www.imasy.or.jp/~kawai/osask/
です。MML ファイルは「OSASKのダウンロードページ」 でなるべく新しいバージョン
のOSASK のページで、「OSASK簡単おすすめパック用追加アプリケーションパック」
をダウンロードしてください。ZAKKI 氏及び川合氏の書かれたMML ファイルが幾つか
あります。


＠インストール・アンインストール

  配布ファイルを解凍後、生成されたファイルを全て同じフォルダに入れてください
。解凍後のどのファイルもレジストリに書き込むことは有りませんので、いらなくな
った場合はフォルダごと消去してください。もちろん解凍後に別のフォルダに入れな
おしても結構です。

＠ファイル構成＊＊＊＊

  配布ファイル、kmp03b.zipを展開すると以下のファイルが作成されます
    kmmlplay.txt →この文書です
    kmmlplay.exe →このソフトの実行ファイルです
    kmmlplay.as  →このソフトのソースファイルです
    kmmlplay.ico →実行ファイルのアイコンファイルです
    hspio.dll    →動作に必要なプラグインです（Ｋ－Ｋ氏作）
    TOUGE.MML    →サンプルファイルです。アメリカ民謡「峠の我が家」
    UMINOKO.MML  →サンプルファイルです。文部省唱歌「我は海の子」
    LICENCE.TXT  →このソフトのライセンス

※ソーススクリプトは基本的にHSP 2.6β15以前では動作しません

＠使用方法＊＊＊＊

  起動すると、ウィンドウが現れます。下の方に11のボタンがあります。それぞれ
次のような意味があります

  [開く]→演奏するMML ファイルをダイアログで選択します
          選択したファイル名はウィンドウに表示されます

  [演奏]→選択したファイルの演奏を開始します
          演奏中はウィンドウの右下に"演"と言う文字が表示されます
          演奏中に押すとその曲の初めに戻ります

  [停止]→演奏を止めます。次に演奏するときはまた初めからになります

  [一時]→演奏を一時停止します
          一時停止中はウィンドウの右下の"演"となっていたところに"停"が表示さ
れます
          もう一度押すと停止した所から演奏を再開します


  [CB]	→クリップボードの内容を演奏します。演奏中に押すと演奏は停止扱いにな
ります

  [監視]→ファイル監視の有効無効を切り替えます
          ファイル監視が有効のときはウィンドウの右下に"監"という文字が表示さ
れます
          ファイル監視が有効になっているときに表示されているファイルを更新す
ると演奏が始まります(演奏ボタンを押したときと同じ) 。

  [<<]	→1 オクターブ下に移調します。押すほど音が低くなります。どれだけ移調
したかはウィンドウの右端に数字で表示されます

  [<]	→半音下に移調します。押すほど音が低くなります。どれだけ移調したかは
ウィンドウの右端に数字で表示されます

  [ﾘｾｯﾄ]→移調をリセットします

  [>]	→半音上に移調します。押すほど音が高くなります。どれだけ移調したかは
ウィンドウの右端に数字で表示されます

  [>>]	→1 オクターブ上に移調します。押すほど音が高くなります。どれだけ移調
したかはウィンドウの右端に数字で表示されます

※[監視][<<][<][ﾘｾｯﾄ][>][>>]を演奏中に押すと、一瞬だけ演奏が中断します
※演奏中でファイル監視が有効になっているとき、発音、消音が切り替わるまで演奏
  は開始されません。これはver.0.5 で改善する予定です
※最後までくるとまた最初に戻り無限に演奏を続けます
※ウィンドウにファイルをドロップするとそのファイルを選択できます。演奏中のと
  きはすぐに演奏します
※プログラムアイコンにドロップしたり関連付けて起動するとそのファイルをすぐに
  演奏します
※複数同時に演奏すると面白いこと(笑)になりますが危ないのでお勧めしません
※演奏中やファイルが選択されている状態でもエディタなどでそのファイルの編集は
  出来ますが、ファイル監視が有効になっていない場合は反映されるのは次に演奏し
  たときです
※何らかの原因で異常終了したときには音が鳴りっぱなしになるかもしれませんが、
  そのような場合は再び起動して終了させてください

＠MML 文法解説＊＊＊＊

  文法はオーソドックスなMML 形式でありOSASK 専用の特別なキーワードがあるわけ
ではありませんが私の知る限りOSASK 以外では演奏できるソフトはありません。
  なお、以下<n> は0 及び正の整数を表します。なお、大文字で表記してありますが
、小文字でも構いません。サンプルファイルも参考にしてください

・設定系

    設定系のコマンドは

      T120

  の様に記述します。この場合テンポを120 に設定せよという意味になります。数字
  も含めて間に何も挟まずに一続きに記入してください

  T<n>	テンポを設定します。0 の場合や設定しないと120 になります。単位は60秒
        あたりの四分音符の数です。数を多くすると曲が早く演奏されます。最大値
        はHSP の制約により2147483647となっています。ただ、計算上240000以上の
        数値を指定することは意味がありません

  O<n>	オクターブを設定します。設定しない場合は4 になります。数が大きいほど
        音が高くなります。あまり高い音や低い音は正しく発音されません

  L<n>	音符を書くときに長さを指定しない場合の音符の長さを設定します。4 にす
        ると四分音符、1 にすると全音符になります。0 の場合や設定しない場合は
        4 になります。最大値は192 です。それ以上の値を入れても変わりません

  Q<n>	音符を発音する長さの割合を設定します。設定した数字/8の長さで演奏され
        ます。タイの場合最後の音符にのみ適用されます。最大値は8 です。8 以上
        を入れると一音目がその長さで発音された後、無限ウェイトがかかります。
        これはOSASK のmmlplay と同じ仕様です

  >	以降一オクターブ上げます

  <	以降一オクターブ下げます

・音符系

    音符は

      E#2.

  の様に記述します。この場合付点二分音符レのシャープを演奏せよという意味にな
  ります。& を使わない場合はここまでを間に何も挟まずに一続きに記入してくださ
  い。& を使う場合は& でつながった部分全てで一続きとなります

  CDEFGAB それぞれド、レ、ミ、ファ、ソ、ラ、シです。後ろに数字をつけると例え
          ば4 なら四分音符、1 なら全音符になります

  R	休符です。後ろに数字をつけると例えば4 なら四分休符、1 なら全休符にな
        ります

  #,+	どちらもその音を半音上げます。必ず数字やピリオドの前に書いてください

  -	その音を半音下げます。必ず数字やピリオドの前に書いてください

  .	その音の長さを3/2 倍にします

  &	音と音の間に付けてタイを表します

    一続きのコマンドとコマンドの間にある半角スペースと改行は無視されます。
    改行コードはCR,LF,CRLF,LFCR のどれでも認識します
    その他の解釈できない文字は次の改行（最後の行ではファイルの最後）までをコ
  メントアウトすることを表します
    わかりやすくするため通常はコメントアウトするときは; （セミコロン）を使い
  ます
    コマンドも音符も書いた順番通りに処理されます
    コマンド系の場合書いたところ以降の音符に対して設定が有効になります

＠OSASK について＊＊＊＊

  OSASK とは川合秀実氏が中心となって開発されているオープンソースのOSです。フ
ロッピーにインストールするので気軽に試せます。小柳雅明氏のmmlplay は「ディス
クイメージ版」にバンドルされています。ダウンロードはここからたどってください
http://www.imasy.org/~kawai/osask/

＠予定＊＊＊＊

  ver.1.0 までには以下の機能を実装する予定です
  ・プレイリストの読み込み
  ・転調機能
  ・MIDIファイル書き出し
  ・MML エディタの統合
  ・BEEP音キーボード
  ・WAVEファイルにレンダリング
  ・PC-98 への対応（こちら側に昇格）
  ・演奏ルーチンをDLL 化し、別スレッドで演奏させる(これによって演奏状況を詳細
に表示できるようになります)
  ・DDE による制御を可能に

  以下の機能は可能であれば実装します
  ・調の自動判定
  ・聖人氏のMML にも対応（MIDIファイルの書き出しのみ。演奏は無理です。こっちに格下げです）

  独自仕様はver.1.0 以降に…できればいいな

  OSASK 版の製作も検討中です

  Windows 上でOSASK 用のMML の記述環境を整えるのが最終目標です。もっともそれ
までにはOSASK でMIDIが演奏できるようになっているかもしれませんが(^^;

＠謝辞＊＊＊＊

  このソフトを作成するにあたって、川合氏のmusic シリーズのソースコードとＫ－
Ｋ氏のiobeep.as （hspio.dll 付属）を大いに参考にさせていただきました。特に周
波数設定の部分はほとんどmusic シリーズのコピーです。またプラグインとしてＫ－
Ｋ氏のhspio.dll を使用させていただきました。PC-98x1 かどうかを判定する部分は
島田  啓史氏のIf98.dllのソースを参考にさせて頂きました。
  ソフト制作に使用したHot Soup Processor（HSP） はonion softwareのおにたま氏
の開発された無料で使用できるインタープリタ言語処理系です。

「ONION softwareのHSPホームページ」
http://www.onionsoft.net/hsp/

  Ｋ－Ｋ氏のホームページ
http://www.chichibu.ne.jp/~kawahira/

  島田  啓史氏のホームページ
http://www.valley.ne.jp/~hirosoft/

＠私の著作物以外のものについて＊＊＊＊

  同梱させていただいたプラグイン、hspio.dll の著作権はＫ－Ｋ氏にあります。

＠ライセンス＊＊＊＊

  私の著作物全てのライセンスについてはLICENCE.TXT を参照してください

＠動作確認環境＊＊＊＊

  一応制作環境での動作確認をしております。以下に制作環境を示します。

FMV-6300NA2/L
OS	Microsoft Windows98 Second Edition
CPU	Intel Mobile Pentium Ⅱ 300MHz
RAM	224 MB

DIMENSION 4100
OS	Microsoft Windows2000 Professional SP2
CPU	Intel Pentium Ⅲ 1GHz
RAM	192 MB

ThinkPad 230Cs（死亡）
OS	Microsoft Windows95（最も初期のバージョン）
CPU	Intel i486 SX 33MHz
RAM	12 MB

  このソフトなどTHAGAが作成したソフトの最新情報は
  http://www.h5.dion.ne.jp/~markent
にあります、是非アクセスしてください

＠開発履歴＊＊＊＊

  ver.0.3a (03/03/11)
  ・一時停止機能を付けた
  ・ファイルを選択していないときに再生ボタンを押してもダイアログが出ないよう
にした
  ・"開く"でファイルを選択しなかった後にファイルをドロップしても表示がすぐに
更新されないバグを修正

  ver.0.3 (02/12/13)
  ・いつの頃からか、停止ボタンを押してもインデックス部分が0 に戻らなくなって
いたのを修正
  ・ver.0.2dでの変更により、プチプチノイズが入るようになっていたのを修正
  ・この文書で途中までしか書いていなかったところがあったので書き足しました
  ・やっとこさクリップボードの内容を演奏する機能が付きました

  ver.0.2d (02/12/12)
  ・消音方法をOSASK のソースを見て変更。心なしかOSASK の音により近づいたよう
な気がする（DAIKU.MMLを演奏したときなんか）
  ・移調時にリズムが崩れないようにした。ずっと違う方法を考えていたのであるが
、移調の時飛んだラベルから戻るときに、MML ファイルのインデックスのバックアッ
プを取っておいて、そこに戻せば良いことに気付く(^^;
  ・ソフトの名前を変数に入れるようにしてサイズを減らした。メモリ消費は64バイ
トほど増えましたが(^^;
  ・PC-98x1 用のコードを埋め込みました。ソースにおいてpc98の値を1 に設定すれ
ばPC-98x1 モードになりますが、危険ですのでテスト目的以外には行わないで下さい
。ただ、私の環境ではPC-98x1 モードでも問題は起きませんでした。近いうちにPC-9
8x1 対応のαバージョンを出す予定です。詳しくはホームページに記載する予定です
  ・ライセンスを「川合堂ライセンス-01」 に変更しました。ライセンス文はそのま
ま利用させて頂いています
  ・ボタンを小さくしました（機能追加の予定があるため）

  ver.0.2c (02/11/19)
  ・起動時にPC-98x1 かどうかをチェックするように変更。PC-98x1 であればダイア
ログを出して終了します。島田  啓史氏のHSP プラグイン、If98.dllのソースを参考
にさせて頂きました。

  ver.0.2b (02/11/18)
  ・ランタイムをHSP 2.6β15 のものに変更したのに伴いloadlib.dll をアーカイブ
からはずした（サイズは増えましたが、ディスク使用量は変わっていません）
  ・場合によってはファイルが正常に読みこめなくなるバグを修正
  ・演奏中にそのファイルのサイズが変わると、実際には演奏しないのに表示のサイ
ズも変わっていたのを修正（どうでもいいんだけどね）
  ・ver.0.2aで追加した変数をひとつ減らした
  ・このテキストのMML 文法解説に一部不適当な表現があったのを修正

  ver.0.2a (02/11/07)
  ・恐ろしいバグを修正。この所為である特定の条件のファイルが再生出来なくなっ
ていました。いままでよく動いていたものです…。指摘してくださったZAKKI 様に感
謝いたします
  ・演奏中にもドロップできるようになりました
  ・0 で除算をする恐れがあったのを修正
  ・ファイルが演奏できないときはすぐに停止するようにした

  ver.0.2 (02/09/19)
  ・発音方法を川合氏のmusic シリーズのものに変更。これにより高い音や低い音
も割と正しく発音されるようになりました
  ・マイナスのオクターブのとき正常に発音されないのを修正
  ・UMINOKO.MML 演奏時の不具合（正確にはタイのフラグの問題）をタイのフラグ
を4 通りにすることによって解決。また最初に戻る場合、タイのフラグもクリアされ
るようにした
  ・移調関係のボタンを増やした
  ・上記の変更に伴い余分なモジュールを切り捨てた
  ・演奏中にも移調ができるようにした。ただし曲の調子は狂う
  ・ランタイムをHSP 2.6β14 のものに変更
  ・移調できる音数を-999999～999999 に制限した
  ・再生中も移調ができるようにしたため、MML でないファイルを演奏するとき演
奏中かどうかがわかりにくくなったので。演奏中は演奏中と表示するようにした

  ver.0.1a (02/09/17)
  ・音符表示が3 つ上になっていたのを修正（対症療法です）
  ・新たにUMINOKO.MML を同梱

ver.0.1（初公開）
  02/09/12
  ・見た目を一新
  ・演奏中に演奏ボタンを押すと最初から演奏されないバグを10日に埋め込んでいた
ので修正
  ・アイコン作成
  02/09/11
  （試験当日のため開発中断）
  02/09/10
  ・フォントを小さくした
  ・インデックスも表示するようにした
  ・表示更新のとき画面がちらつかないようにした
  02/09/09
  ・小文字でも認識できるようにした
  ・音長が0 のとき、既定値もしくは設定値を使用するようにした
  ・ウィンドウの横幅を広くした
  ・ボタンの位置を変更。移調用のラベルを2 つに整理
  02/09/08
  ・移調機能をさくっと付けた
  ・暫定的なウィンドウインタフェースを付けた
  ・ウィンドウへのドラッグアンドドロップに対応
  ・ループにウェイトを入れるようにした
  ・終了時の挙動を変更
  ・休符のときにも画面が更新されるようにした
  ・変数の初期化を一回だけやるようにした
  ・高速で再生するとなぜかオクターブだけが上がってくるので対症療法を施す。原
因は不明
  02/09/07
  ・不完全だったタイの処理がようやく完成。ただちょっと非効率かも
  ・コメントアウトの認識方法を変えることにより、最後の行でコメントアウトがあ
ったときにフリーズしないようにした。しかしやはり見た目が非効率だ
  ・起動時に音を消すようにした
  ・川合氏のMML プレイヤーの方法では上手く音がでなかったので、Ｋ－Ｋ氏のiobe
ep.as の方式に変更、少し改造したらOSASK のMML プレーヤーと音が同じになった
  ・コマンドラインからのファイルの読み込みにも対応
  ・おまけで現在の状態が表示されるようにした
  02/09/06
  ・ほぼ完成。リズムがおかしかったのは休符の処理が間違っていたからであった。
完成度は90パーセント。音の高さがおかしい
  02/09/05
  ・取り敢えず音が出るようになった。解釈部分は80パーセントといったところか。
& の処理が未完成。リズムが非常におかしい
  02/09/04
  ・解釈部分が50パーセントできる
  02/09/03
  ・MML を勉強
  02/09/02
  ・着想