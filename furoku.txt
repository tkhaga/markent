==expdef付録==

  Borland C++ Compiler 5.5を用いてHSP用のプラグインを作る方法(02/12/13版)

＠目次(行数を表示できるエディタをお持ちの方のために)＊＊＊＊

  ＠はじめに＊＊＊＊
    →18行目から
  ＠作成手順＊＊＊＊
    →30行目から
  ＠技＊＊＊＊
    →99行目から
  ＠詳細解説＊＊＊＊
    →135行目から
  ＠おわりに＊＊＊＊
    →168行目から

＠はじめに＊＊＊＊

  HSPのマニュアルにはMicrosoft Visual C++とBorland C++ Builderでの拡張プラグイ
ン(DLL)の作成方法が記載されていますがどちらも初心者が使うには少し値段が高いので
はないかと思います(私はどちらも持っていません^^;)。そこで、このテキストでBorlan
d C++ Builderのメーカー、ボーランド社が無償で配布しているBorland C++ Compiler 5
.5を用いてDLLを作成する方法を解説します。Borland C++ Builderとは違ってコマンドラ
インから使用しなければなりませんが、コマンドの入力方法も解説しているので、是非
試してみてください。C,C++についての知識があることと、HSP本体があることを前提と
させていただきます。また、このテキストはエディタ等の横幅を80文字分ぐらいにして
おくと読みやすくなります。

＠作成手順＊＊＊＊

１、作成するDLLのソースを作成してください。HSPの仕様に基づいていればC,C++どちら
  の規格でも結構です。HSPの仕様についてはHSPマニュアルの「HSPマニュアル総合イン
  デックス」から「HSPからのDLL呼び出し方法リファレンスマニュアル(上級者向け) (
  hspdll.htm)」又はインターネット上のhttp://www.onionsoft.net/hsp/hspdll.htmlを
  参照してください。

２、*.def(ファイル名は適当でよい)という空のファイルを作成し以下の内容をテキスト
  エディタ等で打ち込みます("関数名"のところには、ソースで定義した関数の名前を定
  義した数だけ以下のように記述してください)
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃EXPORTS                                                                     ┃
┃_(関数名その１)@16            =(関数名その１)                               ┃
┃_(関数名その２)@16            =(関数名その２)                               ┃
┃             .                                                              ┃
┃             .                                                              ┃
┃             .                                                              ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
(例)
  Hot Soup Processorのホームページで配布されているサンプルDLL,autochk.dllの場合
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃EXPORTS                                                                     ┃
┃_dlltest@16                   =dlltest                                      ┃
┃                                                                            ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
３、MS-DOSプロンプト(またはコマンドプロンプト)を起動し、Borland C++ Compiler 5.
  5のインストールされているフォルダ(bcc32.exe等のあるフォルダ)に移動して以下の
  コマンドを打ち込みます。このとき作成するDLLのソースファイルも同じフォルダに入
  れておいてください。
  このときBorland C++ Compiler 5.5のインストールされているフォルダにパスが通っ
  ていれば、好きなフォルダで作業が出来ます。詳しくは下の「技」で解説します。
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃bcc32 -c (ソースファイル名)                                                 ┃
┃                                                                            ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
      *.obj(オブジェクトファイル)が同じフォルダに作成されたかを確認してください
。

４、続けて以下のコマンドを打ち込んでください
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ilink32 -Tpd c0d32x.obj (作成された*.objのファイル名).obj,(作成するDLLの名前┃
┃).dll,,import32.lib cw32.lib,(作成した*.defファイル名).def                  ┃
┃                                                                            ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
      c0d32x.objがスタートアップ、cw32.lib及びimport32.libがランタイムです。cw32
  .libは標準関数のオブジェクトファイルであり、import32.libはWindowsのAPIを呼び出
  すためのオブジェクトファイルです。(詳しくは下の「詳細解説」にて)

  これでDLLファイルが同じフォルダに作成されたはずです、HSPを使ってテストしてく
  ださい。また、マルチスレッドを使用する場合はcw32.libのところをcw32mt.libに
  変更してください。他にもファイルがたくさん出来ますが、-Tpdの隣に-xを付ければ
  その数が一つ減ります。

(例)
  Hot Soup Processorのホームページで配布されているサンプルDLL,autochk.dllの場合
  (*.defファイルはtest.defとしたとして)
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃bcc32 -c autochk.cpp                                                        ┃
┃                                                                            ┃
┃ilink32 -Tpd c0d32x.obj autochk.obj,autochk.dll,,import32.lib cw32.lib,test.┃
┃def                                                                         ┃
┃                                                                            ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
      また*.defファイルのところは拡張子を省略して
    test
  とすることも出来ます。

＠技＊＊＊＊

  --その１--
  Windows95系列の場合(95,98,98SE Meは未確認)、起動ドライブのルートにあるautoexe
c.batの一番下に次の行を追加するとわざわざBorland C++ Compiler 5.5のあるフォルダ
まで移動せずにbcc32やilink32のコマンドを任意のフォルダから使用できます
  SET PATH=%PATH%;(Borland C++ Compiler 5.5のあるフォルダ)
ちなみに、私の環境では
  SET PATH=%PATH%;d:\borland\bcc55\bin
となっています。Cドライブはいっぱいです^^;)
  WindowsNT系列の場合(2000のみ確認)、"システムのプロパティ"から"環境変数"ボタン
を押し、環境変数PATHにBorland C++ Compiler 5.5のあるフォルダを追加します。
(これらの設定を簡単に行うソフトもあるらしいです)

  --その２--
  DLLが作成できなかったりHSPから呼び出せなかった場合はc0d32x.objのところをc0d32
w.obj,c0d32.obj,c0s32.obj等に変
えてみて下さい。これらの*.libファイルはLibフォルダにあります。

  --その３--
  ２つ以上のソースを結合させる場合は、bcc32でそれぞれの*.objファイルを作成し、il
ink32のところでc0d32x.obj test1.obj test2.obj(test1.obj,test2.objを作成した場合)
の様にしてください。bcc32は２つ以上のソースファイルの入力にも対応しています。
  --その４--
  ソースファイルをコンパイルする際に（bcc32コマンド）、-O1,-O2をオプションとし
て指定すると、生成オブジェクトファイルの最適化を行うことが出来ます。-O1オプショ
ンではサイズの最適化、-O2では実行速度の最適化を行えます。-O1は余り効き目があり
ませんが、-O2はなかなか効果があります。

  --その５--
  cw32.libをcw32i.libに変更すると、DLLファイルのサイズを減らすことが出来ます。た
だ、この場合代わりにBorland C++ Builder 5のランタイムが必要になってしまいます。
一般に配布する場合はcw32.libを使った方が良いでしょう。


＠詳細解説＊＊＊＊

  bcc32とは？
    正確にはbcc32.exeであり、Borland C++ Compiler 5.5のメインプログラムです。本
来ならばこのプログラムが後に解説するilink32等を自動的に呼び出してソースからプロ
グラムを作成できるのですが、HSPの拡張プラグインを作るときはこれではうまく行きま
せん。そのため、取り敢えずこの場合はbcc32に-cオプションを付けてオブジェクトファ
イルを作成し、ilink32は別に起動して細かな設定をします。詳細は、HSPマニュアルの
「HSPマニュアル総合インデックス」から「HSPからのDLL呼び出し方法リファレンスマニ
ュアル(上級者向け) (hspdll.htm)」を参照してください。

  ilink32とは？
    正確にはilink32.exeであり、Borland C++ Compiler 5.5のリンカーです。リンカー
の役割はランタイム、スタートアップをオブジェクトファイルとスタティック(静的)に
結合して実行可能ファイルを作成することです(自分でも何を書いているのやら^^;)。こ
こではモジュール定義ファイル(*.def)を用意してDLLの関数名をエクスポートすること
によって、HSPが認識できるDLLを作成します。詳細は、HSPマニュアルの「HSPマニュア
ル総合インデックス」から「HSPからのDLL呼び出し方法リファレンスマニュアル(上級者
向け) (hspdll.htm)」を...^^;)

  オブジェクトファイルとは？
    オブジェクトファイルとはソースファイルをコンピュータが命令として認識できる
ネイティブコードに直した(コンパイルした)ものですが、これだけでは起動することが
出来ません。

  スタートアップとは？
    スタートアップとはオブジェクトファイルにスタティック(静的)に結合される、プ
ログラムを起動するのに必要なものです。

  モジュール定義ファイルとは？
    ここではDLLの関数名をHSPが認識できる形式に変換するために使用しています。本
当はもっといろいろな設定ができます。

＠おわりに＊＊＊＊

  実は書いている本人C,C++に余り詳しいわけではありません、分かっていたでしょうが
...ということでもしかしたらもっと高速化が出来たりファイルサイズをもっと小さくす
る方法があるかもしれません。皆さんもいろいろ試してみてください、私はもう限界で
す^^;)御意見、御質問、誤ったことが書かれていましたらぜひ私までお寄せください。
また、この文章を書くにあたって矢沢久雄氏の『プログラムはなぜ動くのか』(日経ＢＰ
社)を大幅に参考にさせていただきました、(Borland C++Compiler 5.5の使い方も少しだ
け載っています;^^)この場をお借りしてお礼申し上げます。また、コンパイラを無償で
提供して下さっているボーランド社にも大変感謝しております。C,C++は高いお金を払わ
なければ出来なかったというのはもう過去の話です。皆さんもこれを機にプログラミン
グに挑戦してみてはいかがでしょうか？

・Hot Soup Processorホームページ
    http://www.onionsoft.net/hsp/

・ボーランド社ホームページ
    http://www.borland.co.jp/

・日経ＢＰ社ホームページ
    http://store.nikkeibp.co.jp/

(クリッカブルURLに対応したエディタならばここからホームページにジャンプできます)

                                     書き始め  2002/01/20
                                     最終更新  2002/12/13
                                                         Written by THAGA(さが)
誤植、ご要望などありましたらどうぞ→                 e-mail thaga@k7.dion.ne.jp
